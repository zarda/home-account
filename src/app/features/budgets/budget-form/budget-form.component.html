<div class="budget-form-dialog">
  <!-- Header -->
  <div class="flex items-center justify-between px-6 py-4 border-b">
    <h2 class="text-xl font-semibold">
      {{ data.mode === 'add' ? ('budget.createBudget' | translate) : ('budget.editBudget' | translate) }}
    </h2>
    <button mat-icon-button (click)="onCancel()">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <form [formGroup]="form" (ngSubmit)="onSubmit()">
    <mat-dialog-content class="!px-6 !py-4">
      <!-- Budget name -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>{{ 'budget.budgetName' | translate }}</mat-label>
        <input matInput formControlName="name" [placeholder]="'budget.budgetNamePlaceholder' | translate">
        @if (form.get('name')?.hasError('required') && form.get('name')?.touched) {
          <mat-error>{{ 'budget.nameRequired' | translate }}</mat-error>
        }
      </mat-form-field>

      <!-- Category selection -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>{{ 'transactions.category' | translate }}</mat-label>
        <mat-select formControlName="categoryId">
          <mat-select-trigger>
            @if (selectedCategory(); as cat) {
              <div class="flex items-center gap-2">
                <mat-icon [style.color]="cat.color" class="!text-lg">{{ cat.icon }}</mat-icon>
                <span>{{ cat.name | translate }}</span>
              </div>
            }
          </mat-select-trigger>
          @for (category of expenseCategories(); track category.id) {
            <mat-option [value]="category.id">
              <div class="flex items-center gap-2">
                <mat-icon [style.color]="category.color" class="!text-lg">
                  {{ category.icon }}
                </mat-icon>
                <span>{{ category.name | translate }}</span>
              </div>
            </mat-option>
          }
        </mat-select>
        @if (form.get('categoryId')?.hasError('required') && form.get('categoryId')?.touched) {
          <mat-error>{{ 'transactions.categoryRequired' | translate }}</mat-error>
        }
      </mat-form-field>

      <!-- Amount and Currency -->
      <div class="flex gap-4">
        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>{{ 'budget.budgetAmount' | translate }}</mat-label>
          <input matInput type="number" formControlName="amount" step="0.01" min="0.01">
          @if (form.get('amount')?.hasError('required') && form.get('amount')?.touched) {
            <mat-error>{{ 'budget.amountRequired' | translate }}</mat-error>
          }
          @if (form.get('amount')?.hasError('min')) {
            <mat-error>{{ 'budget.amountMustBePositive' | translate }}</mat-error>
          }
        </mat-form-field>

        <mat-form-field appearance="outline" class="w-28">
          <mat-label>{{ 'settings.currency' | translate }}</mat-label>
          <mat-select formControlName="currency">
            @for (currency of currencies; track currency.code) {
              <mat-option [value]="currency.code">
                {{ currency.code }}
              </mat-option>
            }
          </mat-select>
        </mat-form-field>
      </div>

      <!-- Period and Start Date -->
      <div class="flex gap-4">
        <mat-form-field appearance="outline" class="flex-1">
          <mat-label>{{ 'budget.budgetPeriod' | translate }}</mat-label>
          <mat-select formControlName="period">
            @for (period of periods; track period.value) {
              <mat-option [value]="period.value">{{ period.label }}</mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="flex-1"
                        [matTooltip]="'budget.startDateTooltip' | translate"
                        matTooltipPosition="above">
          <mat-label>{{ 'budget.startDateOptional' | translate }}</mat-label>
          <input matInput [matDatepicker]="picker" formControlName="startDate" [placeholder]="'budget.useDefault' | translate">
          <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
        </mat-form-field>
      </div>

      <!-- Alert threshold slider -->
      <div class="threshold-section mt-4 mb-2">
        <span class="block text-xs text-gray-500 dark:text-gray-400 mb-3 text-center" id="threshold-label">{{ 'budget.alertWhenReaches' | translate }}: <strong class="text-sm text-gray-700 dark:text-gray-200">{{ form.value.alertThreshold }}%</strong></span>
        <div class="slider-container">
          <mat-slider min="50" max="100" step="5" aria-labelledby="threshold-label" discrete>
            <input matSliderThumb formControlName="alertThreshold">
          </mat-slider>
          <div class="flex justify-between text-xs text-gray-400 dark:text-gray-500 mt-1">
            <span>50%</span>
            <span>100%</span>
          </div>
        </div>
      </div>
    </mat-dialog-content>

    <mat-dialog-actions class="!px-6 !py-4 border-t">
      <button mat-stroked-button type="button" (click)="onCancel()">
        {{ 'common.cancel' | translate }}
      </button>
      <button mat-flat-button color="primary" type="submit"
              [disabled]="form.invalid || isSubmitting()">
        @if (isSubmitting()) {
          <mat-spinner diameter="20" class="inline-block mr-2"></mat-spinner>
        }
        {{ data.mode === 'add' ? ('budget.createBudget' | translate) : ('transactions.saveChanges' | translate) }}
      </button>
    </mat-dialog-actions>
  </form>
</div>
