<div class="category-breakdown">
  <!-- Type Toggle -->
  <div class="type-toggle">
    <mat-button-toggle-group
      [value]="selectedType()"
      (change)="selectedType.set($event.value)"
    >
      <mat-button-toggle value="expense">
        <mat-icon>trending_down</mat-icon>
        {{ 'common.totalExpenses' | translate }}
      </mat-button-toggle>
      <mat-button-toggle value="income">
        <mat-icon>trending_up</mat-icon>
        {{ 'common.income' | translate }}
      </mat-button-toggle>
    </mat-button-toggle-group>

    <div class="total-display">
      <span class="total-label">{{ selectedType() === 'expense' ? ('reports.totalExpenses' | translate) : ('reports.totalIncome' | translate) }}</span>
      <span class="total-value" [class.expense]="selectedType() === 'expense'" [class.income]="selectedType() === 'income'">
        {{ total() | currency:currencyCode:'symbol':'1.2-2' }}
      </span>
    </div>
  </div>

  @if (!hasData()) {
    <app-empty-state
      icon="pie_chart"
      [title]="selectedType() === 'expense' ? ('reports.noExpenses' | translate) : ('reports.noIncome' | translate)"
      [description]="translationService.t('reports.noTransactionsForPeriod', { type: selectedType() })"
    />
  } @else {
    <!-- Category Panels -->
    <mat-accordion class="categories-accordion">
      @for (category of categoryBreakdown(); track category.categoryId) {
        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title>
              <div class="category-header">
                <div class="category-icon" [style.background-color]="category.color + '20'">
                  <mat-icon [style.color]="category.color">{{ category.icon }}</mat-icon>
                </div>
                <span class="category-name">{{ category.name | translate }} <span class="category-count">({{ category.transactionCount }})</span></span>
              </div>
            </mat-panel-title>
            <mat-panel-description>
              <div class="category-stats">
                <span class="category-amount desktop-only">{{ category.total | currency:currencyCode:'symbol':'1.2-2' }}</span>
                <span class="category-percentage">{{ category.percentage | number:'1.0-0' }}%</span>
              </div>
            </mat-panel-description>
          </mat-expansion-panel-header>

          <div class="category-details">
            <!-- Progress bar -->
            <div class="percentage-bar">
              <div
                class="percentage-fill"
                [style.width.%]="category.percentage"
                [style.background-color]="category.color"
              ></div>
            </div>

            <!-- Stats grid -->
            <div class="stats-grid">
              <div class="stat-item">
                <span class="stat-label">{{ 'reports.totalAmount' | translate }}</span>
                <span class="stat-value">{{ category.total | currency:currencyCode:'symbol':'1.2-2' }}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">{{ 'reports.avgPerTransaction' | translate }}</span>
                <span class="stat-value">{{ category.averageAmount | currency:currencyCode:'symbol':'1.2-2' }}</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">{{ 'reports.percentOfTotal' | translate }}</span>
                <span class="stat-value">{{ category.percentage | number:'1.1-1' }}%</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">{{ 'reports.transactionsCount' | translate }}</span>
                <span class="stat-value">{{ category.transactionCount }}</span>
              </div>
            </div>

            <!-- Recent transactions in this category -->
            <div class="recent-transactions">
              <h4 class="section-title">{{ 'reports.recentTransactions' | translate }}</h4>
              <div class="transactions-list">
                @for (transaction of getTransactionsForCategory(category.categoryId); track transaction.id) {
                  <div class="transaction-item">
                    <div class="transaction-info">
                      <span class="transaction-description">{{ transaction.description }}</span>
                      <span class="transaction-date">{{ transaction.date.toDate() | date:'MMM d, yyyy' }}</span>
                    </div>
                    <span class="transaction-amount">
                      {{ transaction.amount | currency:transaction.currency:'symbol':'1.2-2' }}
                    </span>
                  </div>
                }
              </div>
            </div>
          </div>
        </mat-expansion-panel>
      }
    </mat-accordion>
  }
</div>
