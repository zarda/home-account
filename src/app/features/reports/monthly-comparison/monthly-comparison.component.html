@if (!hasData()) {
  <app-empty-state
    icon="bar_chart"
    title="No Data Available"
    description="Add some transactions to see your monthly comparison."
  />
} @else {
  <div class="monthly-comparison">
    <!-- Summary Stats -->
    <div class="summary-stats">
      <div class="stat-card">
        <div class="stat-icon avg-income">
          <mat-icon>trending_up</mat-icon>
        </div>
        <div class="stat-content">
          <span class="stat-label">Avg. Monthly Income</span>
          <span class="stat-value income">{{ averageIncome() | currency:currencyCode:'symbol':'1.2-2' }}</span>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon avg-expense">
          <mat-icon>trending_down</mat-icon>
        </div>
        <div class="stat-content">
          <span class="stat-label">Avg. Monthly Expenses</span>
          <span class="stat-value expense">{{ averageExpense() | currency:currencyCode:'symbol':'1.2-2' }}</span>
        </div>
      </div>

      @if (bestMonth()) {
        <div class="stat-card">
          <div class="stat-icon best">
            <mat-icon>emoji_events</mat-icon>
          </div>
          <div class="stat-content">
            <span class="stat-label">Best Month</span>
            <span class="stat-value">{{ bestMonth()?.month }}</span>
            <span class="stat-detail positive">+{{ bestMonth()?.balance | currency:currencyCode:'symbol':'1.2-2' }}</span>
          </div>
        </div>
      }

      @if (worstMonth()) {
        <div class="stat-card">
          <div class="stat-icon worst">
            <mat-icon>warning</mat-icon>
          </div>
          <div class="stat-content">
            <span class="stat-label">Worst Month</span>
            <span class="stat-value">{{ worstMonth()?.month }}</span>
            <span class="stat-detail" [class.negative]="worstMonth()!.balance < 0" [class.positive]="worstMonth()!.balance >= 0">
              {{ worstMonth()!.balance >= 0 ? '+' : '' }}{{ worstMonth()?.balance | currency:currencyCode:'symbol':'1.2-2' }}
            </span>
          </div>
        </div>
      }
    </div>

    <!-- Bar Chart -->
    <mat-card class="chart-card">
      <mat-card-header>
        <mat-card-title>Monthly Income vs Expenses</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="chart-container">
          <canvas
            baseChart
            [type]="chartType"
            [data]="chartData()"
            [options]="chartOptions"
          ></canvas>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Monthly Table -->
    <mat-card class="table-card">
      <mat-card-header>
        <mat-card-title>Monthly Details</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="table-container">
          <table mat-table [dataSource]="monthlyData()" class="monthly-table">
            <!-- Month Column -->
            <ng-container matColumnDef="month">
              <th mat-header-cell *matHeaderCellDef>Month</th>
              <td mat-cell *matCellDef="let row">{{ row.month }}</td>
            </ng-container>

            <!-- Income Column -->
            <ng-container matColumnDef="income">
              <th mat-header-cell *matHeaderCellDef>Income</th>
              <td mat-cell *matCellDef="let row" class="income-cell">
                {{ row.income | currency:currencyCode:'symbol':'1.2-2' }}
                @if (row.incomeChange !== null) {
                  <span class="change-indicator" [class.positive]="row.incomeChange >= 0" [class.negative]="row.incomeChange < 0">
                    <mat-icon>{{ row.incomeChange >= 0 ? 'arrow_upward' : 'arrow_downward' }}</mat-icon>
                    {{ row.incomeChange | number:'1.1-1' }}%
                  </span>
                }
              </td>
            </ng-container>

            <!-- Expense Column -->
            <ng-container matColumnDef="expense">
              <th mat-header-cell *matHeaderCellDef>Expenses</th>
              <td mat-cell *matCellDef="let row" class="expense-cell">
                {{ row.expense | currency:currencyCode:'symbol':'1.2-2' }}
                @if (row.expenseChange !== null) {
                  <span class="change-indicator" [class.positive]="row.expenseChange < 0" [class.negative]="row.expenseChange >= 0">
                    <mat-icon>{{ row.expenseChange >= 0 ? 'arrow_upward' : 'arrow_downward' }}</mat-icon>
                    {{ row.expenseChange | number:'1.1-1' }}%
                  </span>
                }
              </td>
            </ng-container>

            <!-- Balance Column -->
            <ng-container matColumnDef="balance">
              <th mat-header-cell *matHeaderCellDef>Balance</th>
              <td mat-cell *matCellDef="let row" [class.positive]="row.balance >= 0" [class.negative]="row.balance < 0">
                {{ row.balance >= 0 ? '+' : '' }}{{ row.balance | currency:currencyCode:'symbol':'1.2-2' }}
              </td>
            </ng-container>

            <!-- Change Column (for mobile) -->
            <ng-container matColumnDef="change">
              <th mat-header-cell *matHeaderCellDef>Trend</th>
              <td mat-cell *matCellDef="let row">
                @if (row.expenseChange !== null) {
                  <mat-icon
                    class="trend-icon"
                    [class.positive]="row.expenseChange < 0"
                    [class.negative]="row.expenseChange >= 0"
                  >
                    {{ row.expenseChange < 0 ? 'trending_down' : 'trending_up' }}
                  </mat-icon>
                } @else {
                  <span class="no-data">â€”</span>
                }
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
}
